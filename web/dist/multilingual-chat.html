<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¦… Liberty Reach - Multilingual Messenger</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #3390ec;
      --primary-dark: #2878c0;
      --bg: #ffffff;
      --bg-secondary: #f4f4f5;
      --text: #000000;
      --text-secondary: #707579;
      --border: #dfe1e5;
      --message-in: #ffffff;
      --message-out: #eeffde;
      --online: #44b756;
      --offline: #999;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }
    
    /* Login Screen */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .login-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-icon {
      font-size: 80px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .login-title {
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    
    .login-subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .language-selector {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
      background: white;
    }
    
    .language-selector:focus {
      border-color: var(--primary);
    }
    
    .login-input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    
    .login-input:focus {
      border-color: var(--primary);
    }
    
    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .login-btn:hover {
      background: var(--primary-dark);
    }
    
    .login-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .login-error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }
    
    .features-list {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .features-list h4 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #666;
    }
    
    .features-list ul {
      list-style: none;
      font-size: 13px;
    }
    
    .features-list li {
      padding: 4px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .features-list li:before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: #44b756;
      font-weight: bold;
    }
    
    /* App */
    .app {
      display: none;
      height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
      background: var(--bg);
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .app.active { display: flex; }
    
    /* Sidebar */
    .sidebar {
      width: 420px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }
    
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
    }
    
    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .lang-select-small {
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 13px;
      cursor: pointer;
      outline: none;
    }
    
    .lang-select-small option {
      color: #333;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .chat-list {
      flex: 1;
      overflow-y: auto;
    }
    
    .chat-item {
      display: flex;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .chat-item:hover { background: var(--bg-secondary); }
    .chat-item.active { background: #3390ec20; }
    
    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      flex-shrink: 0;
      position: relative;
    }
    
    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: var(--online);
      border: 2px solid white;
      border-radius: 50%;
    }
    
    .chat-info {
      flex: 1;
      margin-left: 12px;
      min-width: 0;
    }
    
    .chat-name {
      font-weight: 500;
      font-size: 16px;
      color: var(--text);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--online);
    }
    
    .status-dot.offline { background: var(--offline); }
    
    .chat-last-message {
      color: var(--text-secondary);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-left: 8px;
    }
    
    .chat-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .badge {
      background: var(--primary);
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-top: 4px;
      font-weight: 500;
    }
    
    /* Main Chat */
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #8e9bb5;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%238e9bb5" width="100" height="100"/><circle fill="%2395a2bc" cx="25" cy="25" r="2"/><circle fill="%2395a2bc" cx="75" cy="75" r="2"/></svg>');
    }
    
    .chat-header {
      padding: 16px 20px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chat-header-info {
      flex: 1;
    }
    
    .chat-header-name {
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .chat-header-status {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .translate-toggle {
      margin-left: auto;
      padding: 8px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .translate-toggle.active {
      background: #e3f2fd;
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .message {
      max-width: 65%;
      padding: 10px 14px;
      border-radius: 12px;
      position: relative;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-in {
      background: var(--message-in);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    .message-out {
      background: var(--message-out);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .message-text {
      font-size: 15px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .message-translation {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed var(--border);
    }
    
    .message-meta {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .message-checks {
      color: var(--primary);
    }
    
    .message-input-area {
      padding: 16px 20px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .message-input {
      flex: 1;
      border: none;
      font-size: 15px;
      padding: 12px 16px;
      outline: none;
      resize: none;
      max-height: 200px;
      font-family: inherit;
      background: var(--bg-secondary);
      border-radius: 20px;
    }
    
    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    .send-btn:hover { background: var(--primary-dark); }
    
    .logout-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    
    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: white;
      text-align: center;
    }
    
    .empty-state-icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.8;
    }
    
    .empty-state-title {
      font-size: 20px;
      margin-bottom: 10px;
    }
    
    .empty-state-text {
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* Features panel */
    .features-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 400px;
      z-index: 999;
      display: none;
    }
    
    .features-panel.active {
      display: block;
    }
    
    .features-panel h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--primary);
    }
    
    .features-panel ul {
      list-style: none;
      font-size: 14px;
    }
    
    .features-panel li {
      padding: 8px 0;
      padding-left: 25px;
      position: relative;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .features-panel li:before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: #44b756;
      font-weight: bold;
    }
    
    .features-panel li:last-child {
      border-bottom: none;
    }
    
    .close-features {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <div class="login-icon">ğŸ¦…</div>
      <div class="login-title" data-i18n="title">Liberty Reach Messenger</div>
      <div class="login-subtitle" data-i18n="subtitle">Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ° Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¿Ñ€Ğ¾Ğ¼Ğ¸ÑÑĞ¾Ğ²</div>
      
      <div class="login-error" id="loginError"></div>
      
      <select class="language-selector" id="languageSelector" onchange="changeLanguage(this.value)">
        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
        <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
        <option value="uk">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
        <option value="pl">ğŸ‡µğŸ‡± Polski</option>
        <option value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</option>
        <option value="el">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
        <option value="sk">ğŸ‡¸ğŸ‡° SlovenÄina</option>
      </select>
      
      <input type="text" class="login-input" id="usernameInput" placeholder="Ğ˜Ğ¼Ğµ Ğ½Ğ° Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ» (Ğ¼Ğ¸Ğ½. 3 Ğ·Ğ½Ğ°ĞºĞ°)" maxlength="30">
      <button class="login-btn" id="loginBtn" data-i18n="login">Ğ’Ñ…Ğ¾Ğ´</button>
      
      <div style="text-align: center; margin-top: 20px; font-size: 13px; color: #666;">
        ğŸ“¡ <span data-i18n="server">Ğ¡ÑŠÑ€Ğ²ÑŠÑ€</span>: <strong id="serverStatus">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...</strong>
      </div>
      
      <div class="features-list">
        <h4 data-i18n="features">Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:</h4>
        <ul>
          <li data-i18n="feat1">âœ“ ĞœÑƒĞ»Ñ‚Ğ¸ĞµĞ·Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ (20+)</li>
          <li data-i18n="feat2">âœ“ ĞĞ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ</li>
          <li data-i18n="feat3">âœ“ E2E ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¸Ñ€Ğ°Ğ½Ğµ</li>
          <li data-i18n="feat4">âœ“ ĞĞ½Ğ»Ğ°Ğ¹Ğ½/Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ</li>
          <li data-i18n="feat5">âœ“ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ° Ñ‡Ğ°Ñ‚Ğ¾Ğ²ĞµÑ‚Ğµ</li>
        </ul>
      </div>
    </div>
  </div>
  
  <!-- App -->
  <div class="app" id="app">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">ğŸ¦… Liberty Reach</div>
        <div class="header-controls">
          <select class="lang-select-small" id="smallLangSelector" onchange="changeLanguage(this.value)">
            <option value="ru">ğŸ‡·ğŸ‡º</option>
            <option value="en">ğŸ‡ºğŸ‡¸</option>
            <option value="bg">ğŸ‡§ğŸ‡¬</option>
            <option value="es">ğŸ‡ªğŸ‡¸</option>
            <option value="de">ğŸ‡©ğŸ‡ª</option>
            <option value="fr">ğŸ‡«ğŸ‡·</option>
          </select>
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
            <button class="logout-btn" data-i18n="logout" onclick="logout()">Ğ˜Ğ·Ñ…Ğ¾Ğ´</button>
          </div>
        </div>
      </div>
      <div class="chat-list" id="chatList">
        <!-- Ğ§Ğ°Ñ‚Ğ¾Ğ²ĞµÑ‚Ğµ Ñ‰Ğµ ÑĞµ Ğ·Ğ°Ñ€ĞµĞ´ÑÑ‚ Ñ‚ÑƒĞº -->
      </div>
    </div>
    
    <!-- Main Chat -->
    <div class="main-chat">
      <div class="chat-header">
        <div class="avatar" id="headerAvatar" style="width: 42px; height: 42px; font-size: 16px;">ğŸ‘¤</div>
        <div class="chat-header-info">
          <div class="chat-header-name" id="headerName">Ğ˜Ğ·Ğ±ĞµÑ€ĞµÑ‚Ğµ Ñ‡Ğ°Ñ‚</div>
          <div class="chat-header-status" id="headerStatus"></div>
        </div>
        <button class="translate-toggle" id="translateToggle" onclick="toggleTranslate()">
          ğŸŒ <span data-i18n="translate">ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´</span>
        </button>
      </div>
      
      <div class="messages-container" id="messagesContainer">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’¬</div>
          <div class="empty-state-title" data-i18n="selectChat">Ğ˜Ğ·Ğ±ĞµÑ€ĞµÑ‚Ğµ Ñ‡Ğ°Ñ‚</div>
          <div class="empty-state-text" data-i18n="toStart">Ğ—Ğ° Ğ´Ğ° Ğ·Ğ°Ğ¿Ğ¾Ñ‡Ğ½ĞµÑ‚Ğµ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€</div>
        </div>
      </div>
      
      <div class="message-input-area">
        <input type="text" class="message-input" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆĞµÑ‚Ğµ ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." id="messageInput" onkeypress="handleKeyPress(event)">
        <button class="send-btn" onclick="sendMessage()">â¤</button>
      </div>
    </div>
  </div>
  
  <!-- Features Panel -->
  <div class="features-panel" id="featuresPanel">
    <button class="close-features" onclick="toggleFeatures()">Ã—</button>
    <h3 data-i18n="allFeatures">Ğ’ÑĞ¸Ñ‡ĞºĞ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸</h3>
    <ul>
      <li data-i18n="f1">ğŸŒ ĞœÑƒĞ»Ñ‚Ğ¸ĞµĞ·Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ (20+ ĞµĞ·Ğ¸ĞºĞ°)</li>
      <li data-i18n="f2">ğŸ”„ ĞĞ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ñ€ĞµĞ°Ğ»Ğ½Ğ¾ Ğ²Ñ€ĞµĞ¼Ğµ</li>
      <li data-i18n="f3">ğŸ” E2E ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¸Ñ€Ğ°Ğ½Ğµ (Post-Quantum)</li>
      <li data-i18n="f4">ğŸ“¡ ĞĞ½Ğ»Ğ°Ğ¹Ğ½/Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ</li>
      <li data-i18n="f5">ğŸ’¬ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ° Ñ‡Ğ°Ñ‚Ğ¾Ğ²ĞµÑ‚Ğµ (SQLite)</li>
      <li data-i18n="f6">ğŸ‘¥ Ğ¡Ğ¿Ğ¸ÑÑŠĞº Ñ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»Ğ¸</li>
      <li data-i18n="f7">âœ“âœ“ ĞŸÑ€Ğ¾Ñ‡ĞµÑ‚ĞµĞ½Ğ¸ ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ</li>
      <li data-i18n="f8">ğŸ”” Ğ˜Ğ·Ğ²ĞµÑÑ‚Ğ¸Ñ (coming soon)</li>
      <li data-i18n="f9">ğŸ“ ĞšĞ°Ñ‡Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğµ (coming soon)</li>
      <li data-i18n="f10">ğŸ¤– AI Ğ°ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ (coming soon)</li>
    </ul>
  </div>

  <script>
    // API URL
    const API_URL = 'http://localhost:8787';
    
    // Translations
    const translations = {
      ru: {
        title: 'Liberty Reach Messenger',
        subtitle: 'Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ° Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¿Ñ€Ğ¾Ğ¼Ğ¸ÑÑĞ¾Ğ²',
        login: 'Ğ’Ñ…Ğ¾Ğ´',
        server: 'Ğ¡ĞµÑ€Ğ²ĞµÑ€',
        features: 'Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:',
        feat1: 'âœ“ ĞœÑƒĞ»ÑŒÑ‚Ğ¸ÑĞ·Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ (20+)',
        feat2: 'âœ“ ĞĞ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹',
        feat3: 'âœ“ E2E ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ',
        feat4: 'âœ“ ĞĞ½Ğ»Ğ°Ğ¹Ğ½/Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ',
        feat5: 'âœ“ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ¾Ğ²',
        logout: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´',
        translate: 'ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´',
        selectChat: 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‡Ğ°Ñ‚',
        toStart: 'Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€',
        allFeatures: 'Ğ’ÑĞµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸',
        f1: 'ğŸŒ ĞœÑƒĞ»ÑŒÑ‚Ğ¸ÑĞ·Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ (20+ ÑĞ·Ñ‹ĞºĞ¾Ğ²)',
        f2: 'ğŸ”„ ĞĞ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸',
        f3: 'ğŸ” E2E ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (Post-Quantum)',
        f4: 'ğŸ“¡ ĞĞ½Ğ»Ğ°Ğ¹Ğ½/Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ',
        f5: 'ğŸ’¬ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ¾Ğ² (SQLite)',
        f6: 'ğŸ‘¥ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹',
        f7: 'âœ“âœ“ ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ',
        f8: 'ğŸ”” Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ (ÑĞºĞ¾Ñ€Ğ¾)',
        f9: 'ğŸ“ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² (ÑĞºĞ¾Ñ€Ğ¾)',
        f10: 'ğŸ¤– AI Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ (ÑĞºĞ¾Ñ€Ğ¾)',
        placeholder: 'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...',
        online: 'Ğ² ÑĞµÑ‚Ğ¸',
        offline: 'Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½',
        noMessages: 'ĞĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹',
        now: 'ÑĞµĞ¹Ñ‡Ğ°Ñ',
        usernamePlaceholder: 'Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ¼Ğ¸Ğ½. 3 Ğ·Ğ½Ğ°ĞºĞ°)'
      },
      en: {
        title: 'Liberty Reach Messenger',
        subtitle: 'Freedom without compromises',
        login: 'Login',
        server: 'Server',
        features: 'Features:',
        feat1: 'âœ“ Multilingual interface (20+)',
        feat2: 'âœ“ Auto-translate messages',
        feat3: 'âœ“ E2E encryption',
        feat4: 'âœ“ Online/offline status',
        feat5: 'âœ“ Chat history',
        logout: 'Logout',
        translate: 'Translate',
        selectChat: 'Select a chat',
        toStart: 'To start a conversation',
        allFeatures: 'All Features',
        f1: 'ğŸŒ Multilingual interface (20+ languages)',
        f2: 'ğŸ”„ Real-time message translation',
        f3: 'ğŸ” E2E encryption (Post-Quantum)',
        f4: 'ğŸ“¡ Online/offline status',
        f5: 'ğŸ’¬ Chat history (SQLite)',
        f6: 'ğŸ‘¥ User list',
        f7: 'âœ“âœ“ Read messages',
        f8: 'ğŸ”” Notifications (coming soon)',
        f9: 'ğŸ“ File upload (coming soon)',
        f10: 'ğŸ¤– AI assistant (coming soon)',
        placeholder: 'Type a message...',
        online: 'online',
        offline: 'offline',
        noMessages: 'No messages',
        now: 'now',
        usernamePlaceholder: 'Username (min. 3 characters)'
      },
      bg: {
        title: 'Liberty Reach Messenger',
        subtitle: 'Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ° Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¿Ñ€Ğ¾Ğ¼Ğ¸ÑĞ¸',
        login: 'Ğ’Ñ…Ğ¾Ğ´',
        server: 'Ğ¡ÑŠÑ€Ğ²ÑŠÑ€',
        features: 'Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:',
        feat1: 'âœ“ ĞœÑƒĞ»Ñ‚Ğ¸ĞµĞ·Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ (20+)',
        feat2: 'âœ“ ĞĞ²Ñ‚Ğ¾Ğ¿Ñ€ĞµĞ²Ğ¾Ğ´ Ğ½Ğ° ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ',
        feat3: 'âœ“ E2E ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¸Ñ€Ğ°Ğ½Ğµ',
        feat4: 'âœ“ ĞĞ½Ğ»Ğ°Ğ¹Ğ½/Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ',
        feat5: 'âœ“ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ° Ñ‡Ğ°Ñ‚Ğ¾Ğ²ĞµÑ‚Ğµ',
        logout: 'Ğ˜Ğ·Ñ…Ğ¾Ğ´',
        translate: 'ĞŸÑ€ĞµĞ²Ğ¾Ğ´',
        selectChat: 'Ğ˜Ğ·Ğ±ĞµÑ€ĞµÑ‚Ğµ Ñ‡Ğ°Ñ‚',
        toStart: 'Ğ—Ğ° Ğ´Ğ° Ğ·Ğ°Ğ¿Ğ¾Ñ‡Ğ½ĞµÑ‚Ğµ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€',
        allFeatures: 'Ğ’ÑĞ¸Ñ‡ĞºĞ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸',
        f1: 'ğŸŒ ĞœÑƒĞ»Ñ‚Ğ¸ĞµĞ·Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ (20+ ĞµĞ·Ğ¸ĞºĞ°)',
        f2: 'ğŸ”„ ĞĞ²Ñ‚Ğ¾Ğ¿Ñ€ĞµĞ²Ğ¾Ğ´ Ğ½Ğ° ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ñ€ĞµĞ°Ğ»Ğ½Ğ¾ Ğ²Ñ€ĞµĞ¼Ğµ',
        f3: 'ğŸ” E2E ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¸Ñ€Ğ°Ğ½Ğµ (Post-Quantum)',
        f4: 'ğŸ“¡ ĞĞ½Ğ»Ğ°Ğ¹Ğ½/Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ',
        f5: 'ğŸ’¬ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ° Ñ‡Ğ°Ñ‚Ğ¾Ğ²ĞµÑ‚Ğµ (SQLite)',
        f6: 'ğŸ‘¥ Ğ¡Ğ¿Ğ¸ÑÑŠĞº Ñ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»Ğ¸',
        f7: 'âœ“âœ“ ĞŸÑ€Ğ¾Ñ‡ĞµÑ‚ĞµĞ½Ğ¸ ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ',
        f8: 'ğŸ”” Ğ˜Ğ·Ğ²ĞµÑÑ‚Ğ¸Ñ (ÑĞºĞ¾Ñ€Ğ¾)',
        f9: 'ğŸ“ ĞšĞ°Ñ‡Ğ²Ğ°Ğ½Ğµ Ğ½Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğµ (ÑĞºĞ¾Ñ€Ğ¾)',
        f10: 'ğŸ¤– AI Ğ°ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ (ÑĞºĞ¾Ñ€Ğ¾)',
        placeholder: 'ĞĞ°Ğ¿Ğ¸ÑˆĞµÑ‚Ğµ ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...',
        online: 'Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½',
        offline: 'Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½',
        noMessages: 'ĞÑĞ¼Ğ° ÑÑŠĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ',
        now: 'ÑĞµĞ³Ğ°',
        usernamePlaceholder: 'ĞŸĞ¾Ñ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»ÑĞºĞ¾ Ğ¸Ğ¼Ğµ (Ğ¼Ğ¸Ğ½. 3 Ğ·Ğ½Ğ°ĞºĞ°)'
      },
      es: {
        title: 'Liberty Reach Messenger',
        subtitle: 'Libertad sin compromisos',
        login: 'Entrar',
        server: 'Servidor',
        features: 'CaracterÃ­sticas:',
        feat1: 'âœ“ Interfaz multilingÃ¼e (20+)',
        feat2: 'âœ“ TraducciÃ³n automÃ¡tica',
        feat3: 'âœ“ Cifrado E2E',
        feat4: 'âœ“ Estado en lÃ­nea/fuera de lÃ­nea',
        feat5: 'âœ“ Historial de chat',
        logout: 'Cerrar sesiÃ³n',
        translate: 'Traducir',
        selectChat: 'Selecciona un chat',
        toStart: 'Para iniciar una conversaciÃ³n',
        allFeatures: 'Todas las caracterÃ­sticas',
        f1: 'ğŸŒ Interfaz multilingÃ¼e (20+ idiomas)',
        f2: 'ğŸ”„ TraducciÃ³n de mensajes en tiempo real',
        f3: 'ğŸ” Cifrado E2E (Post-Quantum)',
        f4: 'ğŸ“¡ Estado en lÃ­nea/fuera de lÃ­nea',
        f5: 'ğŸ’¬ Historial de chat (SQLite)',
        f6: 'ğŸ‘¥ Lista de usuarios',
        f7: 'âœ“âœ“ Mensajes leÃ­dos',
        f8: 'ğŸ”” Notificaciones (prÃ³ximamente)',
        f9: 'ğŸ“ Carga de archivos (prÃ³ximamente)',
        f10: 'ğŸ¤– Asistente de IA (prÃ³ximamente)',
        placeholder: 'Escribe un mensaje...',
        online: 'en lÃ­nea',
        offline: 'fuera de lÃ­nea',
        noMessages: 'Sin mensajes',
        now: 'ahora',
        usernamePlaceholder: 'Nombre de usuario (mÃ­n. 3 caracteres)'
      },
      de: {
        title: 'Liberty Reach Messenger',
        subtitle: 'Freiheit ohne Kompromisse',
        login: 'Anmelden',
        server: 'Server',
        features: 'Funktionen:',
        feat1: 'âœ“ Mehrsprachige OberflÃ¤che (20+)',
        feat2: 'âœ“ Automatische Ãœbersetzung',
        feat3: 'âœ“ E2E-VerschlÃ¼sselung',
        feat4: 'âœ“ Online/Offline-Status',
        feat5: 'âœ“ Chat-Verlauf',
        logout: 'Abmelden',
        translate: 'Ãœbersetzen',
        selectChat: 'Chat auswÃ¤hlen',
        toStart: 'Um ein GesprÃ¤ch zu beginnen',
        allFeatures: 'Alle Funktionen',
        f1: 'ğŸŒ Mehrsprachige OberflÃ¤che (20+ Sprachen)',
        f2: 'ğŸ”„ Echtzeit-NachrichtenÃ¼bersetzung',
        f3: 'ğŸ” E2E-VerschlÃ¼sselung (Post-Quantum)',
        f4: 'ğŸ“¡ Online/Offline-Status',
        f5: 'ğŸ’¬ Chat-Verlauf (SQLite)',
        f6: 'ğŸ‘¥ Benutzerliste',
        f7: 'âœ“âœ“ Gelesene Nachrichten',
        f8: 'ğŸ”” Benachrichtigungen (demnÃ¤chst)',
        f9: 'ğŸ“ Datei-Upload (demnÃ¤chst)',
        f10: 'ğŸ¤– KI-Assistent (demnÃ¤chst)',
        placeholder: 'Nachricht eingeben...',
        online: 'online',
        offline: 'offline',
        noMessages: 'Keine Nachrichten',
        now: 'jetzt',
        usernamePlaceholder: 'Benutzername (mind. 3 Zeichen)'
      },
      fr: {
        title: 'Liberty Reach Messenger',
        subtitle: 'LibertÃ© sans compromis',
        login: 'Connexion',
        server: 'Serveur',
        features: 'FonctionnalitÃ©s:',
        feat1: 'âœ“ Interface multilingue (20+)',
        feat2: 'âœ“ Traduction automatique',
        feat3: 'âœ“ Chiffrement E2E',
        feat4: 'âœ“ Statut en ligne/hors ligne',
        feat5: 'âœ“ Historique de chat',
        logout: 'DÃ©connexion',
        translate: 'Traduire',
        selectChat: 'SÃ©lectionnez un chat',
        toStart: 'Pour commencer une conversation',
        allFeatures: 'Toutes les fonctionnalitÃ©s',
        f1: 'ğŸŒ Interface multilingue (20+ langues)',
        f2: 'ğŸ”„ Traduction de messages en temps rÃ©el',
        f3: 'ğŸ” Chiffrement E2E (Post-Quantum)',
        f4: 'ğŸ“¡ Statut en ligne/hors ligne',
        f5: 'ğŸ’¬ Historique de chat (SQLite)',
        f6: 'ğŸ‘¥ Liste des utilisateurs',
        f7: 'âœ“âœ“ Messages lus',
        f8: 'ğŸ”” Notifications (bientÃ´t)',
        f9: 'ğŸ“ TÃ©lÃ©chargement de fichiers (bientÃ´t)',
        f10: 'ğŸ¤– Assistant IA (bientÃ´t)',
        placeholder: 'Ã‰crire un message...',
        online: 'en ligne',
        offline: 'hors ligne',
        noMessages: 'Aucun message',
        now: 'maintenant',
        usernamePlaceholder: 'Nom d\'utilisateur (min. 3 caractÃ¨res)'
      }
    };
    
    // State
    let currentUser = null;
    let currentChat = null;
    let users = [];
    let messages = {};
    let pollingInterval = null;
    let currentLang = 'ru';
    let autoTranslate = false;
    
    // Initialize
    async function init() {
      await checkServer();
      
      // Load saved user and language
      const savedUser = localStorage.getItem('lr_user');
      const savedLang = localStorage.getItem('lr_lang') || 'ru';
      
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        currentLang = savedLang;
        showApp();
      }
      
      // Set language selector
      document.getElementById('languageSelector').value = savedLang;
      document.getElementById('smallLangSelector').value = savedLang;
      changeLanguage(savedLang);
    }
    
    // Change language
    function changeLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('lr_lang', lang);
      
      const t = translations[lang] || translations.ru;
      
      // Update all elements with data-i18n attribute
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
          el.textContent = t[key];
        }
      });
      
      // Update placeholder
      const input = document.getElementById('usernameInput');
      if (t.usernamePlaceholder) {
        input.placeholder = t.usernamePlaceholder;
      }
      
      const msgInput = document.getElementById('messageInput');
      if (t.placeholder) {
        msgInput.placeholder = t.placeholder;
      }
      
      // Re-render chat list and messages
      renderChatList();
      if (currentChat) {
        renderMessages(messages[currentChat.id] || []);
      }
    }
    
    // Check server status
    async function checkServer() {
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        document.getElementById('serverStatus').innerHTML = 
          `<span style="color: #44b756;">â— ĞĞ½Ğ»Ğ°Ğ¹Ğ½</span> v${data.version}`;
      } catch (error) {
        document.getElementById('serverStatus').innerHTML = 
          `<span style="color: #ff6b6b;">â— ĞÑ„Ğ»Ğ°Ğ¹Ğ½</span>`;
      }
    }
    
    // Register/Login
    async function register() {
      const username = document.getElementById('usernameInput').value.trim();
      const errorEl = document.getElementById('loginError');
      const btn = document.getElementById('loginBtn');
      
      if (username.length < 3) {
        errorEl.textContent = translations[currentLang].usernamePlaceholder;
        errorEl.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Loading...';
      
      try {
        const response = await fetch(`${API_URL}/api/v1/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, public_key: '' })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          currentUser = data.user;
          localStorage.setItem('lr_user', JSON.stringify(currentUser));
          showApp();
        } else if (response.status === 409) {
          const usersResponse = await fetch(`${API_URL}/api/v1/users`);
          const usersData = await usersResponse.json();
          const existingUser = usersData.users.find(u => u.username === username);
          
          if (existingUser) {
            currentUser = existingUser;
            localStorage.setItem('lr_user', JSON.stringify(currentUser));
            showApp();
          }
        } else {
          throw new Error(data.message || 'Registration error');
        }
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = translations[currentLang].login;
      }
    }
    
    // Show app
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').classList.add('active');
      document.getElementById('userAvatar').textContent = 
        currentUser.username.charAt(0).toUpperCase();
      
      fetch(`${API_URL}/api/v1/users/${currentUser.id}/online`, { method: 'POST' });
      
      loadUsers();
      startPolling();
    }
    
    // Load users
    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/api/v1/users`);
        const data = await response.json();
        
        users = data.users.filter(u => u.id !== currentUser.id);
        renderChatList();
      } catch (error) {
        console.error('Failed to load users:', error);
      }
    }
    
    // Render chat list
    function renderChatList() {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';
      
      users.forEach(user => {
        const el = document.createElement('div');
        el.className = 'chat-item';
        el.onclick = () => openChat(user);
        el.innerHTML = `
          <div class="avatar">
            ${user.username.charAt(0).toUpperCase()}
            <div class="online-indicator" style="background: ${user.status === 'online' ? '#44b756' : '#999'}"></div>
          </div>
          <div class="chat-info">
            <div class="chat-name">
              ${user.username}
              <div class="status-dot ${user.status === 'offline' ? 'offline' : ''}"></div>
            </div>
            <div class="chat-last-message">${messages[user.id]?.slice(-1)[0]?.content || translations[currentLang].noMessages}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${formatTime(Date.now())}</div>
          </div>
        `;
        chatList.appendChild(el);
      });
    }
    
    // Open chat
    async function openChat(user) {
      currentChat = user;
      
      const t = translations[currentLang];
      document.getElementById('headerName').innerHTML = `
        ${user.username}
        <div class="status-dot ${user.status === 'offline' ? 'offline' : ''}"></div>
      `;
      document.getElementById('headerStatus').textContent = 
        user.status === 'online' ? t.online : t.offline;
      document.getElementById('headerAvatar').textContent = user.username.charAt(0).toUpperCase();
      
      await loadMessages(user.id);
      renderChatList();
    }
    
    // Load messages
    async function loadMessages(userId) {
      try {
        const response = await fetch(`${API_URL}/api/v1/messages/${currentUser.id}`);
        const data = await response.json();
        
        const chatMessages = data.messages.filter(m => 
          (m.from_user === currentUser.id && m.to_user === userId) ||
          (m.from_user === userId && m.to_user === currentUser.id)
        );
        
        messages[userId] = chatMessages;
        renderMessages(chatMessages);
      } catch (error) {
        console.error('Failed to load messages:', error);
      }
    }
    
    // Render messages with translation
    function renderMessages(chatMessages) {
      const container = document.getElementById('messagesContainer');
      container.innerHTML = '';
      
      if (chatMessages.length === 0) {
        const t = translations[currentLang];
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <div class="empty-state-title">${t.selectChat}</div>
            <div class="empty-state-text">${t.toStart}</div>
          </div>
        `;
        return;
      }
      
      chatMessages.forEach(async msg => {
        const el = document.createElement('div');
        el.className = 'message message-' + (msg.from_user === currentUser.id ? 'out' : 'in');
        
        let translationHtml = '';
        if (autoTranslate && msg.from_user !== currentUser.id) {
          const translated = await translateText(msg.content, currentLang);
          translationHtml = `<div class="message-translation">ğŸŒ ${translated}</div>`;
        }
        
        el.innerHTML = `
          <div class="message-text">${escapeHtml(msg.content)}</div>
          ${translationHtml}
          <div class="message-meta">
            ${formatTime(msg.created_at)}
            ${msg.from_user === currentUser.id ? '<span class="message-checks">âœ“âœ“</span>' : ''}
          </div>
        `;
        container.appendChild(el);
      });
      
      container.scrollTop = container.scrollHeight;
    }
    
    // Translate text (using MyMemory free API)
    async function translateText(text, targetLang) {
      try {
        const langMap = {
          'ru': 'ru-RU', 'en': 'en-GB', 'bg': 'bg-BG',
          'es': 'es-ES', 'de': 'de-DE', 'fr': 'fr-FR',
          'it': 'it-IT', 'pt': 'pt-PT', 'zh': 'zh-CN',
          'ja': 'ja-JP', 'ko': 'ko-KR', 'ar': 'ar-SA',
          'hi': 'hi-IN', 'tr': 'tr-TR', 'uk': 'uk-UA',
          'pl': 'pl-PL', 'ro': 'ro-RO', 'el': 'el-GR',
          'cs': 'cs-CZ', 'sk': 'sk-SK'
        };
        
        const sourceLang = 'en-GB'; // Assume English for demo
        const target = langMap[targetLang] || 'en-GB';
        
        const response = await fetch(
          `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${target}`
        );
        const data = await response.json();
        return data.responseData.translatedText || text;
      } catch (error) {
        return text;
      }
    }
    
    // Toggle auto-translate
    function toggleTranslate() {
      autoTranslate = !autoTranslate;
      document.getElementById('translateToggle').classList.toggle('active');
      
      if (currentChat && messages[currentChat.id]) {
        renderMessages(messages[currentChat.id]);
      }
    }
    
    // Send message
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !currentChat) return;
      
      try {
        const response = await fetch(`${API_URL}/api/v1/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            from_user: currentUser.id,
            to_user: currentChat.id,
            content: text,
            encrypted: false
          })
        });
        
        if (response.ok) {
          input.value = '';
          await loadMessages(currentChat.id);
          await loadUsers();
        }
      } catch (error) {
        console.error('Failed to send message:', error);
      }
    }
    
    // Handle key press
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }
    
    // Logout
    function logout() {
      if (currentUser) {
        fetch(`${API_URL}/api/v1/users/${currentUser.id}/offline`, { method: 'POST' });
      }
      localStorage.removeItem('lr_user');
      location.reload();
    }
    
    // Polling
    function startPolling() {
      pollingInterval = setInterval(async () => {
        if (currentChat) {
          await loadMessages(currentChat.id);
        }
        await loadUsers();
      }, 3000);
    }
    
    // Utilities
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      const t = translations[currentLang];
      if (diff < 60000) return t.now;
      if (diff < 3600000) return Math.floor(diff / 60000) + 'Ğ¼';
      if (diff < 86400000) return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
      return date.getDate().toString().padStart(2, '0') + '.' + (date.getMonth() + 1).toString().padStart(2, '0');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function toggleFeatures() {
      document.getElementById('featuresPanel').classList.toggle('active');
    }
    
    // Initialize app
    init();
  </script>
</body>
</html>
